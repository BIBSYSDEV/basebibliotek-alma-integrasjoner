AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: >
  AWS

  Sample SAM Template for AWS

Parameters:
  SharedConfigBucketName:
    Type: String
    Default: 'shared-config-bucket'
    Description: 'Bucket name for shared, persistent configuration files. Created manually before deploying pipeline.'
  LibCodeToAlmaCodeFilePath:
    Type: String
    Default: '/libCode2AlmaCode.json'
    Description: 'Path to the libCode to almaCode mapping file'
  BasebibliotekXmlBucketName:
    Type: String
    Default: "basebibliotek-xml-file"
    Description: Name of bucket for basebibliotek xml file
  ReportBucketName:
    Type: String
    Default: 'basebibliotek-report'
  BasebibliotekUsername:
    Type: String
    Default: "{{resolve:secretsmanager:basebibliotek-login:SecretString:USERNAME}}"
  BasebibliotekPassword:
    Type: String
    Default: "{{resolve:secretsmanager:basebibliotek-login:SecretString:PASSWORD}}"
  BasebibliotekUrl:
    Type: String
    Default: 'https://www.nb.no/baser/bibliotek/eksport/biblev/'
  IllServerUri:
    Type: String
    Default: 'eu01.alma.exlibrisgroup.com'
  AlmaApiHost:
    Type: String
    Default: 'https://api-eu.hosted.exlibrisgroup.com/almaws/v1/'

Globals:
  Function:
    Timeout: 900
    MemorySize: 1798
    Runtime: java11
  Api:
    Cors:
      AllowMethods: "'POST,OPTIONS'"
      AllowHeaders: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
      AllowOrigin: "'*'"
Resources:
  ApiAccessLogGroup:
    Type: AWS::Logs::LogGroup

  ResourceSharingPartnerFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: resource-sharing-partners
      Handler: no.sikt.rsp.ResourceSharingPartnerHandler::handleRequest
      Role: !GetAtt ResourceSharingPartnerHandlerRole.Arn
      Environment:
        Variables:
          REPORT_BUCKET: !Ref ReportBucketName
          BASEBIBLIOTEK_XML_BUCKET: !Ref BasebibliotekXmlBucket
          SHARED_CONFIG_BUCKET: !Ref SharedConfigBucketName
          LIB_CODE_TO_ALMA_CODE_MAPPING_FILE_PATH: !Ref LibCodeToAlmaCodeFilePath
          ILL_SERVER: !Ref IllServerUri
          ALMA_CODE_LOOKUP_TABLE: !Ref AlmaLookupTable
          ALMA_API_HOST: !Ref AlmaApiHost
          ALMA_APIKEY: '{{resolve:secretsmanager:ALMA_APIKEY:SecretString:ALMA_APIKEY}}'
      Events:
        BasebibliotekFileUpload:
          Type: S3
          Properties:
            Bucket: !Ref BasebibliotekXmlBucket
            Events: 's3:ObjectCreated:*'
            Filter:
              S3Key:
                Rules:
                  - Name: suffix
                    Value: '.txt'

  BasebibliotekFetchCronjob:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: basebibliotek-fetch-cronjob
      Handler: no.sikt.BasebibliotekFetchHandler::handleRequest
      Role: !GetAtt BasebibliotekFetchCronjobRole.Arn
      Environment:
        Variables:
          BASEBIBLIOTEK_USERNAME: !Ref BasebibliotekUsername
          BASEBIBLIOTEK_PASSWORD: !Ref BasebibliotekPassword
          BASEBIBLIOTEK_URL: !Ref BasebibliotekUrl
          BASEBIBLIOTEK_XML_BUCKET:  !Ref BasebibliotekXmlBucket
      Events:
        ScheduledUpdate:
          Type: Schedule
          Properties:
            Schedule: cron(0 18 * * ? *)

  ResourceSharingPartnerHandlerRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
          - Effect: Allow
            Action: 's3:GetObject'
            Resource: !Sub "arn:aws:s3:::${SharedConfigBucketName}/*"

  BasebibliotekFetchCronjobRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole


  DefaultLambdaPermissions:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: !Sub DefaultLambdaPermissions-${AWS::StackName}
      Roles:
        - !Ref ResourceSharingPartnerHandlerRole
        - !Ref BasebibliotekFetchCronjobRole
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Action:
              - logs:CreateLogGroup
              - logs:CreateLogStream
              - logs:PutLogEvents
              - lambda:InvokeFunction
            Resource: "*"

  BasebibliotekXmlBucketAccessPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: !Sub BasebibliotekXmlBucketAccessPolicy-${AWS::StackName}
      Roles:
        - !Ref ResourceSharingPartnerHandlerRole
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Action:
              - 's3:*'
            Resource:
              - !Sub '${BasebibliotekXmlBucket.Arn}/*'

  ReportBucketAccessPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: !Sub ReportBucketAccessPolicy-${AWS::StackName}
      Roles:
        - !Ref ResourceSharingPartnerHandlerRole
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Action:
              - 's3:*'
            Resource:
              - !Sub '${ReportBucket.Arn}/*'

  BasebibliotekXmlBucket:
    Type: AWS::S3::Bucket
    Properties:
      AccessControl: Private
      BucketName: !Sub "${BasebibliotekXmlBucketName}-${AWS::AccountId}"
      LifecycleConfiguration:
        Rules:
          - Id: DeleteContentAfter3Days
            Status: Enabled
            ExpirationInDays: 3

  ReportBucket:
    Type: AWS::S3::Bucket
    Properties:
      AccessControl: Private
      BucketName: !Sub "${ReportBucketName}-${AWS::AccountId}"